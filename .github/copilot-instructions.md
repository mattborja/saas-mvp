# Copilot Instructions

## Architecture overview
This is an incremental multi-tenant SaaS workshop. Labs 1-2 build single-tenant foundations; Lab3+ introduce multi-tenancy with data isolation via shard keys.

**Key structural pattern:**
- `Lab1-6/` – Incremental lab code (`client/`, `server/`, `scripts/`)
- `Solution/` – Completed reference implementations per lab (use when stuck)
- Lab3+ splits into two CloudFormation stacks: `shared-template.yaml` (Cognito, shared APIs, tenant management) and `tenant-template.yaml` (Product/Order services with tenant isolation)

**Multi-tenant data model (Lab3+):**
DynamoDB tables use composite keys: `shardId` (partition) = `{tenantId}-{suffix}` + `productId`/`orderId` (sort). This enables tenant isolation and parallel queries across 10 shards per tenant.

## Lambda handler patterns
```python
# Standard handler structure (Lab1 simple, Lab3+ with tenant context)
def handler(event, context):
    tenantId = event['requestContext']['authorizer']['tenantId']  # Lab3+
    tracer.put_annotation(key="TenantId", value=tenantId)         # Lab3+
    logger.log_with_tenant_context(event, "message")              # Lab3+
    # OR logger.info("message") for Lab1-2
    
    payload = json.loads(event['body'], object_hook=lambda d: SimpleNamespace(**d), parse_float=Decimal)
    result = service_dal.operation(event, payload)
    metrics_manager.record_metric(event, "MetricName", "Count", 1)  # Lab3+
    return utils.generate_response(result)
```

**Layer utilities** in `layers/`:
- `logger.py` – AWS Powertools Logger; use `log_with_tenant_context(event, msg)` for Lab3+
- `utils.py` – `generate_response(obj)` for data, `create_success_response(msg)` for confirmations
- `metrics_manager.py` (Lab3+) – EMF metrics with tenant dimension
- `auth_manager.py` (Lab3+) – Role checks: `isTenantAdmin()`, `isSystemAdmin()`, `isSaaSProvider()`

## Build and deploy
```bash
# Lab1-2: Single stack
cd Lab1/scripts && ./deployment.sh -s -c --stack-name serverless-saas-lab1

# Lab3+: Deploy shared FIRST, then tenant
cd Lab3/server
sam build -t shared-template.yaml --use-container && sam deploy --config-file shared-samconfig.toml
sam build -t tenant-template.yaml --use-container && sam deploy --config-file tenant-samconfig.toml
cd ../scripts && ./deployment.sh -c  # Client only after both stacks
```

**Pre-deploy validation:** Scripts run `pylint -E` on all Python files. Fix errors before deploying.

**Automation reference:** `scripts/run_workshop.sh` chains all labs; `scripts/lab*_updates.py` show TODO→implementation patches.

## SAM template conventions
- Lambda runtime: `python3.9`; timeout: 29s; X-Ray tracing enabled
- Lambda Insights layer attached globally: `arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14`
- Environment variables from template (never hardcode): `PRODUCT_TABLE_NAME`, `ORDER_TABLE_NAME`, `POWERTOOLS_SERVICE_NAME`
- IAM roles defined explicitly per service; extend existing `Policies` blocks for new permissions
- API Gateway uses OpenAPI spec inline in template with `x-amazon-apigateway-integration`

## Common gotchas
- Table names are lab-specific (e.g., `Product-Lab1`, `Product-pooled`); match exactly in code
- Angular environments auto-generated by `deployment.sh` from stack outputs; don't commit manual values
- CORS headers must match `utils.py` pattern for all responses
- `Decimal` must be preserved when parsing JSON body (`parse_float=Decimal`) to avoid DynamoDB type errors

## Key files for understanding
| Concept | Reference file |
|---------|---------------|
| Basic Lambda+DynamoDB | [Lab1/server/ProductService/product_service.py](Lab1/server/ProductService/product_service.py) |
| Tenant-aware data access | [Solution/Lab3/server/ProductService/product_service_dal.py](Solution/Lab3/server/ProductService/product_service_dal.py) |
| Shard-based queries | `__query_all_partitions()` in above DAL |
| SAM template structure | [Lab1/server/template.yaml](Lab1/server/template.yaml) |
| Multi-stack pattern | [Lab3/server/shared-template.yaml](Lab3/server/shared-template.yaml) + tenant-template.yaml |
| Deploy script | [Lab1/scripts/deployment.sh](Lab1/scripts/deployment.sh) |
| Environment setup | [setup/install.sh](setup/install.sh), [setup/check-versions.sh](setup/check-versions.sh) |
